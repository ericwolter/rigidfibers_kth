% arara: lualatex: { shell : yes }

\documentclass[a4paper,11pt]{kth-mag}

% Math and code packages
\usepackage{amsmath}   % all things math
\usepackage{amssymb}   % additional math symbols
\usepackage{xfrac}     % nice fractions in body of text
\usepackage{siunitx}   % typesets numbers with units
\usepackage{mathtools} % extensions for amsmath
\usepackage{minted}    % advanced code examples

% Tables
\usepackage{booktabs} % professionally looking tables
\usepackage{tabulary} % whole page tables

% Caption and split floats
\usepackage{caption}    % customizable captions
\usepackage{subcaption} % nice subfigures and subtables

% Bibliographies
\usepackage{biblatex} % modern bibliographies

% PDF Metadata
\usepackage{hyperref} % enables PDF hyperlinks

% Fonts, typography and languages
\usepackage{fontspec}     % all things fonts
\defaultfontfeatures{Ligatures=TeX}
\setmainfont{FiraSans-Book.otf}[
  BoldFont = FiraSans-SemiBold.otf,
  ItalicFont = FiraSans-Italic.otf,
  BoldItalicFont = FiraSans-SemiBoldItalic.otf]
\setsansfont{FiraSans-Regular.otf}[Scale=MatchLowercase]
\setmonofont{FiraMono-Bold.otf}[Scale=MatchLowercase]
\usepackage{unicode-math} % use custom fonts for math
\setmathfont{XITS Math}
\usepackage{microtype}	  % advanced typesetting
\usepackage[main=english, swedish]{babel} % language-specific conventions

% Graphics
\usepackage{graphicx} % all things graphics
\usepackage{pgfplots} % complex graphs
\usepackage{pgfplotstable}
\pgfplotsset{
  compat=1.11, % avoid running in backwards compatibility mode
  width=\textwidth,
  tick label style = {font=\ttfamily},
  every axis label = {font=\sffamily},
  legend style = {font=\sffamily},
  label style = {font=\sffamily},
  separate axis lines,
  y axis line style={draw opacity=0},
  x axis line style={gray},
  axis x line*=bottom,
  axis y line*=left,
  major tick length=0pt,
  grid=both,
  y grid style={dashed},
  legend pos=north west,
}
\definecolor{set11}{cmyk}{.1 ,.9 ,.8 ,.0 }
\definecolor{set12}{cmyk}{.8 ,.3 ,.0 ,.0 }
\definecolor{set13}{cmyk}{.7 ,.0 ,.8 ,.0 }
\definecolor{set14}{cmyk}{.4 ,.65,.0 ,.0 }
\definecolor{set15}{cmyk}{.0 ,.5 ,1.0,.0 }
\definecolor{set16}{cmyk}{.0 ,.0 ,.8 ,.0 }
\definecolor{set17}{cmyk}{.35,.6 ,.8 ,.0 }
\definecolor{set18}{cmyk}{.0 ,.5 ,.0 ,.0 }
\definecolor{set19}{cmyk}{.0 ,.0 ,.0 ,.4 }

\definecolor{set11_light}{cmyk}{.0 ,.3 ,.2 ,.0 }
\definecolor{set12_light}{cmyk}{.3 ,.1 ,.0 ,.0 }
\definecolor{set13_light}{cmyk}{.2 ,.0 ,.2 ,.0 }
\definecolor{set14_light}{cmyk}{.12 ,.17,.0 ,.0 }
\definecolor{set15_light}{cmyk}{.0 ,.15 ,.3,.0 }
\definecolor{set16_light}{cmyk}{.0 ,.0 ,.2 ,.0 }
\definecolor{set17_light}{cmyk}{.1,.12 ,.2 ,.0 }
\definecolor{set18_light}{cmyk}{.0 ,.15 ,.0 ,.0 }
\definecolor{set19_light}{cmyk}{.0 ,.0 ,.0 ,.05 }

\usepackage{modifications}

\linespread{1.2}

\title{GPU Simulation of Rigid Fibers}

\foreigntitle{GPU simulering av stela fibrer}

\author{Eric Wolter}
\date{January 2015}
\blurb{Master's Thesis at School of Engineering Sciences\\Supervisor: Katarina Gustavsson\\Examiner: Michael Hanke}
\trita{TRITA xxx yyyy-nn}

\begin{document}
\frontmatter
\pagestyle{empty}

\maketitle
\selectlanguage{english}
\begin{abstract}
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Mauris
purus. Fusce tempor. Nulla facilisi. Sed at turpis. Phasellus eu
ipsum. Nam porttitor laoreet nulla. Phasellus massa massa, auctor
rutrum, vehicula ut, porttitor a, massa. Pellentesque fringilla. Duis
nibh risus, venenatis ac, tempor sed, vestibulum at, tellus. Class
aptent taciti sociosqu ad litora torquent per conubia nostra, per
inceptos hymenaeos.
\end{abstract}

\clearpage


\begin{foreignabstract}{swedish}
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Mauris
purus. Fusce tempor. Nulla facilisi. Sed at turpis. Phasellus eu
ipsum. Nam porttitor laoreet nulla. Phasellus massa massa, auctor
rutrum, vehicula ut, porttitor a, massa. Pellentesque fringilla. Duis
nibh risus, venenatis ac, tempor sed, vestibulum at, tellus. Class
aptent taciti sociosqu ad litora torquent per conubia nostra, per
inceptos hymenaeos.
\end{foreignabstract}

\clearpage

\tableofcontents*

\mainmatter
\pagestyle{newchap}

\chapter{Introduction}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/overall.csv}\loadedtable
    \begin{axis}[
      title=Overall,
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      ymin=0,ymax=16,
      xmin=0,xmax=700,
      unbounded coords=discard,
      ]
    \addplot[set11,mark=*,mark options={fill=white}, very thick] table[x=X,y=FortranMulti] {\loadedtable};
    \addplot[set12,mark=*,mark options={fill=white}, very thick] table[x=X,y=2D_GMRES] {\loadedtable};
    \addplot[set13,mark=*,mark options={fill=white}, very thick] table[x=X,y=2D_BiCGStab] {\loadedtable};
    \addplot[set14,mark=*,mark options={fill=white}, very thick] table[x=X,y=MAGMA] {\loadedtable};

    \legend{Fortran Multi,GMRES, BiCGStab, MAGMA}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Total time per timestep using the average over 10 timesteps. First timestep is excluded as warmup. Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/steps_magma.csv}\loadedtable
    \begin{axis}[
      stack plots=y,
      area style,
      title=Steps (CUDA),
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=3
      ]
    \addplot[color=set11, fill=set11_light, very thick] table[x=X,y=assemble_system] {\loadedtable} \closedcycle;
    \addplot[color=set12, fill=set12_light, very thick] table[x=X,y=solve_system] {\loadedtable} \closedcycle;
    % update_fibers is so small it just causes ugly undefined jagginess of the lines
    % so we just add it to update velocities and rename both to update system
    \addplot[color=set13, fill=set13_light, very thick] table[x=X,y expr=\thisrow{update_velocities} + \thisrow{update_fibers}] {\loadedtable} \closedcycle;
    % \addplot[color=set14, fill=set14_light, very thick] table[x=X,y=update_fibers] {\loadedtable} \closedcycle;

    \legend{Assemble System, Solve System (MAGMA), Update System}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for each simulation step over 10 timesteps. First timestep is excluded as warmup.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/steps_fortran.csv}\loadedtable
    \begin{axis}[
      stack plots=y,
      area style,
      title=Steps (Fortran),
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=16,
      ]
    \addplot[color=set11, fill=set11_light, very thick] table[x=X,y expr=(\thisrow{ASSEMBLE_MATRIX} + \thisrow{ASSEMBLE_RHS}) * 0.125] {\loadedtable} \closedcycle;
    \addplot[color=set12, fill=set12_light, very thick] table[x=X,y expr=\thisrow{SOLVE_SYSTEM} * 0.125] {\loadedtable} \closedcycle;
    % update_fibers is so small it just causes ugly undefined jagginess of the lines
    % so we just add it to update velocities and rename both to update system
    \addplot[color=set13, fill=set13_light, very thick] table[x=X,y expr=(\thisrow{ASSEMBLE_FORCE} + \thisrow{UPDATE_VELOCITIES} + \thisrow{UPDATE_FIBERS}) * 0.125] {\loadedtable} \closedcycle;
    % \addplot[color=set14, fill=set14_light, very thick] table[x=X,y=update_fibers] {\loadedtable} \closedcycle;

    \legend{Assemble System, Solve System, Update System}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for each simulation step over 10 timesteps. First timestep is excluded as warmup. Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \begin{axis}[
      title=Assemble System (CUDA vs. Fortran),
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=8
      ]
    \addplot[color=set11,mark=*,mark options={fill=white}, very thick] table[x=X,y expr=(\thisrow{ASSEMBLE_MATRIX} + \thisrow{ASSEMBLE_RHS}) * 0.125] {benchmarks/steps_fortran.csv};
    \addplot[color=set12,mark=*,mark options={fill=white}, very thick] table[x=X,y expr=\thisrow{ASSEMBLE_MATRIX} * 0.125] {benchmarks/steps_fortran_new.csv};
    \addplot[color=set13,mark=*,mark options={fill=white}, very thick] table[x=X,y=assemble_system] {benchmarks/steps_magma.csv};

    \legend{Assemble System (Fortran), Assemble System (Fortran - New), Assemble System (CUDA)}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for assemble system step. Fortran and CUDA are averaged over 10 timesteps (1st excluded). Fortran New is only 1st timestep. Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \begin{axis}[
      title=Solve System (CUDA vs. Fortran),
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=4.5,
      ]
    \addplot[color=set11,mark=*,mark options={fill=white}, very thick] table[x=X,y expr=\thisrow{SOLVE_SYSTEM} * 0.125] {benchmarks/steps_fortran.csv};
    \addplot[color=set12,mark=*,mark options={fill=white}, very thick] table[x=X,y=solve_system] {benchmarks/steps_magma.csv};

    \legend{Solve System (Fortran), Solve System (CUDA - MAGMA)}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for solve system step. Averaged over 10 timesteps (1st excluded). Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/assemble_system_grid.csv}\loadedtable
    \begin{axis}[
      title=CUDA Grid Dimension,
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      ymin=0,ymax=0.8,
      xmin=0,xmax=700,
      unbounded coords=discard,
      ]
    \addplot[set12,mark=*,mark options={fill=white}, very thick] table[x=X,y=2D] {\loadedtable};
    \addplot[set13,mark=*,mark options={fill=white}, very thick] table[x=X,y=3D] {\loadedtable};
    \addplot[set14,mark=*,mark options={fill=white}, very thick] table[x=X,y=3D2] {\loadedtable};

    \legend{1D, 2D, 3D, 3D2}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Total time per timestep using the average over 10 timesteps. First timestep is excluded as warmup.}
\end{figure}

\chapter{Theoretical Foundation}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed cursus ut arcu eget ultricies. Nam eu ex eget nisl feugiat faucibus vel non lorem. Cras condimentum laoreet turpis ac laoreet. In ipsum nunc, ornare in aliquet eu, congue a ipsum. Nulla scelerisque hendrerit dignissim. Mauris sit amet leo scelerisque, blandit urna sit amet, ullamcorper justo. Morbi sollicitudin pellentesque lorem, id pretium velit efficitur in. Quisque finibus ornare eros quis elementum. Morbi auctor dignissim imperdiet. Cras eget interdum turpis. Quisque sit amet lacus risus. In rhoncus bibendum turpis vel aliquet.

Cras tempus dolor in nibh tristique dapibus. Nunc sollicitudin erat id purus pulvinar, eget eleifend nisl luctus. In sit amet felis nibh. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec consequat lacus risus, vel mattis eros venenatis at. In scelerisque, odio id molestie egestas, arcu metus tincidunt tortor, et varius dolor arcu ac quam. Donec ipsum quam, aliquam ac elit sit amet, elementum bibendum nisi. Vivamus pharetra lobortis arcu ut tincidunt. Fusce pellentesque metus quis augue pretium pretium a at ipsum. Nullam sit amet luctus sapien. Vivamus eget pellentesque risus. Mauris vitae nibh erat. Fusce id libero at ligula egestas pharetra in in odio.

Nulla sed diam vitae urna maximus ornare. Integer id metus pharetra, ultricies nisi ut, molestie nisl. Ut elementum leo eget sem semper posuere. Cras ac cursus mi. Nam feugiat, ligula ut ultricies sollicitudin, nibh urna dapibus justo, ac condimentum dui lorem et nunc. Donec accumsan nisl maximus bibendum congue. In a placerat nisl. Praesent pharetra tincidunt velit, vel sagittis tortor laoreet a. Integer fringilla leo et commodo condimentum. Pellentesque ultricies nunc eleifend justo semper, at cursus velit commodo. Donec quis scelerisque mauris. Phasellus quis pretium leo. Praesent sit amet ipsum non risus ullamcorper accumsan sit amet sit amet eros.

Quisque fringilla sem ut luctus aliquam. Praesent accumsan non eros at vestibulum. Aenean et massa non est viverra eleifend. Nullam consequat mi sed elit vestibulum, vel consectetur odio maximus. Maecenas a tortor sapien. Nam vel mattis risus, quis consequat nisl. Integer in elit tortor. Morbi feugiat non mi non molestie. Phasellus tempus purus purus, non gravida mauris vestibulum at. Nullam lobortis varius nisl eget consectetur. Nullam eu nisl ex. Praesent vitae vehicula erat. Nulla rutrum erat mi, in vestibulum lacus porta a.

Suspendisse pretium, erat ac mattis bibendum, libero lectus eleifend leo, quis vulputate urna sapien ut purus. Mauris metus elit, tempus vel urna nec, ullamcorper ornare lacus. Aenean et ante gravida, vulputate nibh ultricies, ultricies metus. Fusce egestas accumsan dolor. Vestibulum elit velit, rutrum eu erat luctus, ornare aliquet tortor. Nam et nunc consectetur, gravida metus nec, eleifend elit. Curabitur vestibulum quam ut metus tempor, at mollis magna sollicitudin. Fusce bibendum, mi sed rhoncus sagittis, est arcu condimentum turpis, et accumsan sem tellus sit amet nulla. Nunc aliquam tellus id nisi commodo venenatis. Ut dapibus finibus aliquet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque non semper turpis, nec bibendum lectus.

\chapter{CPU Implementation}


Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed cursus ut arcu eget ultricies. Nam eu ex eget nisl feugiat faucibus vel non lorem. Cras condimentum laoreet turpis ac laoreet. In ipsum nunc, ornare in aliquet eu, congue a ipsum. Nulla scelerisque hendrerit dignissim. Mauris sit amet leo scelerisque, blandit urna sit amet, ullamcorper justo. Morbi sollicitudin pellentesque lorem, id pretium velit efficitur in. Quisque finibus ornare eros quis elementum. Morbi auctor dignissim imperdiet. Cras eget interdum turpis. Quisque sit amet lacus risus. In rhoncus bibendum turpis vel aliquet.

Cras tempus dolor in nibh tristique dapibus. Nunc sollicitudin erat id purus pulvinar, eget eleifend nisl luctus. In sit amet felis nibh. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec consequat lacus risus, vel mattis eros venenatis at. In scelerisque, odio id molestie egestas, arcu metus tincidunt tortor, et varius dolor arcu ac quam. Donec ipsum quam, aliquam ac elit sit amet, elementum bibendum nisi. Vivamus pharetra lobortis arcu ut tincidunt. Fusce pellentesque metus quis augue pretium pretium a at ipsum. Nullam sit amet luctus sapien. Vivamus eget pellentesque risus. Mauris vitae nibh erat. Fusce id libero at ligula egestas pharetra in in odio.

Nulla sed diam vitae urna maximus ornare. Integer id metus pharetra, ultricies nisi ut, molestie nisl. Ut elementum leo eget sem semper posuere. Cras ac cursus mi. Nam feugiat, ligula ut ultricies sollicitudin, nibh urna dapibus justo, ac condimentum dui lorem et nunc. Donec accumsan nisl maximus bibendum congue. In a placerat nisl. Praesent pharetra tincidunt velit, vel sagittis tortor laoreet a. Integer fringilla leo et commodo condimentum. Pellentesque ultricies nunc eleifend justo semper, at cursus velit commodo. Donec quis scelerisque mauris. Phasellus quis pretium leo. Praesent sit amet ipsum non risus ullamcorper accumsan sit amet sit amet eros.

Quisque fringilla sem ut luctus aliquam. Praesent accumsan non eros at vestibulum. Aenean et massa non est viverra eleifend. Nullam consequat mi sed elit vestibulum, vel consectetur odio maximus. Maecenas a tortor sapien. Nam vel mattis risus, quis consequat nisl. Integer in elit tortor. Morbi feugiat non mi non molestie. Phasellus tempus purus purus, non gravida mauris vestibulum at. Nullam lobortis varius nisl eget consectetur. Nullam eu nisl ex. Praesent vitae vehicula erat. Nulla rutrum erat mi, in vestibulum lacus porta a.

Suspendisse pretium, erat ac mattis bibendum, libero lectus eleifend leo, quis vulputate urna sapien ut purus. Mauris metus elit, tempus vel urna nec, ullamcorper ornare lacus. Aenean et ante gravida, vulputate nibh ultricies, ultricies metus. Fusce egestas accumsan dolor. Vestibulum elit velit, rutrum eu erat luctus, ornare aliquet tortor. Nam et nunc consectetur, gravida metus nec, eleifend elit. Curabitur vestibulum quam ut metus tempor, at mollis magna sollicitudin. Fusce bibendum, mi sed rhoncus sagittis, est arcu condimentum turpis, et accumsan sem tellus sit amet nulla. Nunc aliquam tellus id nisi commodo venenatis. Ut dapibus finibus aliquet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque non semper turpis, nec bibendum lectus.

\chapter{GPU Implementation}
\section{CUDA}
\section{Optimizations}

\chapter{Results}
\section{CPU vs. GPU}
\section{Fortran vs. CUDA}
\section{Scaling}

\chapter{Conclusions}

\appendix
\addappheadtotoc

\end{document}
