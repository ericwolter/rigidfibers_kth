% arara: lualatex: { shell : yes }

\documentclass[a4paper,11pt]{kth-mag}

% Math and code packages
\usepackage{amsmath}   % all things math
\usepackage{amssymb}   % additional math symbols
\usepackage{xfrac}     % nice fractions in body of text
\usepackage{siunitx}   % typesets numbers with units
\usepackage{mathtools} % extensions for amsmath
%\usepackage{minted}    % advanced code examples

% Tables
\usepackage{booktabs} % professionally looking tables
\usepackage{tabulary} % whole page tables

% Caption and split floats
\usepackage{caption}    % customizable captions
\usepackage{subcaption} % nice subfigures and subtables

% Bibliographies
\usepackage{biblatex} % modern bibliographies

% PDF Metadata
\usepackage{hyperref} % enables PDF hyperlinks

% Fonts, typography and languages
\usepackage{fontspec}     % all things fonts
\defaultfontfeatures{Ligatures=TeX}
\setmainfont{FiraSans-Book.otf}[
  BoldFont = FiraSans-SemiBold.otf,
  ItalicFont = FiraSans-Italic.otf,
  BoldItalicFont = FiraSans-SemiBoldItalic.otf]
\setsansfont{FiraSans-Regular.otf}[Scale=MatchLowercase]
\setmonofont{FiraMono-Bold.otf}[Scale=MatchLowercase]
\usepackage{unicode-math} % use custom fonts for math
\setmathfont{XITS Math}
\usepackage{microtype}	  % advanced typesetting
\usepackage[main=english, swedish]{babel} % language-specific conventions

% Graphics
\usepackage{graphicx} % all things graphics
\usepackage{pgfplots} % complex graphs
\usepackage{pgfplotstable}
\pgfplotsset{
  compat=1.11, % avoid running in backwards compatibility mode
  width=\textwidth,
  tick label style = {font=\ttfamily},
  every axis label = {font=\sffamily},
  legend style = {font=\sffamily},
  label style = {font=\sffamily},
  separate axis lines,
  y axis line style={draw opacity=0},
  x axis line style={gray},
  axis x line*=bottom,
  axis y line*=left,
  major tick length=0pt,
  grid=both,
  y grid style={dashed},
  legend pos=north west,
}
\definecolor{set11}{RGB}{228,  26,  28}
\definecolor{set12}{RGB}{ 55, 126, 184}
\definecolor{set13}{RGB}{ 77, 175,  74}
\definecolor{set14}{RGB}{152,  78, 163}
\definecolor{set15}{RGB}{255, 127,   0}
\definecolor{set16}{RGB}{255, 255,  51}
\definecolor{set17}{RGB}{166,  86,  40}
\definecolor{set18}{RGB}{247, 129, 191}
\definecolor{set19}{RGB}{153, 153, 153}

\definecolor{set11_light}{RGB}{251, 180, 174}
\definecolor{set12_light}{RGB}{179, 205, 227}
\definecolor{set13_light}{RGB}{204, 235, 197}
\definecolor{set14_light}{RGB}{222, 203, 228}
\definecolor{set15_light}{RGB}{254, 217, 166}
\definecolor{set16_light}{RGB}{255, 255, 204}
\definecolor{set17_light}{RGB}{229, 216, 189}
\definecolor{set18_light}{RGB}{253, 218, 236}
\definecolor{set19_light}{RGB}{242, 242, 242}

% \definecolor{set11}{cmyk}{.1 ,.9 ,.8 ,.0 }
% \definecolor{set12}{cmyk}{.8 ,.3 ,.0 ,.0 }
% \definecolor{set13}{cmyk}{.7 ,.0 ,.8 ,.0 }
% \definecolor{set14}{cmyk}{.4 ,.65,.0 ,.0 }
% \definecolor{set15}{cmyk}{.0 ,.5 ,1.0,.0 }
% \definecolor{set16}{cmyk}{.0 ,.0 ,.8 ,.0 }
% \definecolor{set17}{cmyk}{.35,.6 ,.8 ,.0 }
% \definecolor{set18}{cmyk}{.0 ,.5 ,.0 ,.0 }
% \definecolor{set19}{cmyk}{.0 ,.0 ,.0 ,.4 }
%
% \definecolor{set11_light}{cmyk}{.0 ,.3 ,.2 ,.0 }
% \definecolor{set12_light}{cmyk}{.3 ,.1 ,.0 ,.0 }
% \definecolor{set13_light}{cmyk}{.2 ,.0 ,.2 ,.0 }
% \definecolor{set14_light}{cmyk}{.12 ,.17,.0 ,.0 }
% \definecolor{set15_light}{cmyk}{.0 ,.15 ,.3,.0 }
% \definecolor{set16_light}{cmyk}{.0 ,.0 ,.2 ,.0 }
% \definecolor{set17_light}{cmyk}{.1,.12 ,.2 ,.0 }
% \definecolor{set18_light}{cmyk}{.0 ,.15 ,.0 ,.0 }
% \definecolor{set19_light}{cmyk}{.0 ,.0 ,.0 ,.05 }

\usepackage{modifications}

\linespread{1.2}

\title{GPU Simulation of Rigid Fibers}

\foreigntitle{GPU simulering av stela fibrer}

\author{Eric Wolter}
\date{January 2015}
\blurb{Master's Thesis at School of Engineering Sciences\\Supervisor: Katarina Gustavsson\\Examiner: Michael Hanke}
\trita{TRITA xxx yyyy-nn}

\begin{document}
\frontmatter
\pagestyle{empty}

\maketitle
\selectlanguage{english}
\begin{abstract}
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Mauris
purus. Fusce tempor. Nulla facilisi. Sed at turpis. Phasellus eu
ipsum. Nam porttitor laoreet nulla. Phasellus massa massa, auctor
rutrum, vehicula ut, porttitor a, massa. Pellentesque fringilla. Duis
nibh risus, venenatis ac, tempor sed, vestibulum at, tellus. Class
aptent taciti sociosqu ad litora torquent per conubia nostra, per
inceptos hymenaeos.
\end{abstract}

\clearpage


\begin{foreignabstract}{swedish}
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Mauris
purus. Fusce tempor. Nulla facilisi. Sed at turpis. Phasellus eu
ipsum. Nam porttitor laoreet nulla. Phasellus massa massa, auctor
rutrum, vehicula ut, porttitor a, massa. Pellentesque fringilla. Duis
nibh risus, venenatis ac, tempor sed, vestibulum at, tellus. Class
aptent taciti sociosqu ad litora torquent per conubia nostra, per
inceptos hymenaeos.
\end{foreignabstract}

\clearpage

\tableofcontents*

\mainmatter
\pagestyle{newchap}

\chapter{Introduction}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \begin{axis}[
      title=Overall,
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=16,
      unbounded coords=discard,
      ]
    \addplot[set11,mark=*,mark options={fill=white}, very thick] table[x=X,y expr=\thisrow{TOTAL} * 0.125] {benchmarks/katarina_gmres_analytical.csv};
    \addplot[set12,mark=*,mark options={fill=white}, very thick] table[x=X,y=total]  {benchmarks/cuda_gmres_numerical_2D.csv};
    \addplot[set13,mark=*,mark options={fill=white}, very thick] table[x=X,y=total]  {benchmarks/cuda_bicgstab_numerical_2D.csv};
    % \addplot[set14,mark=*,mark options={fill=white}, very thick] table[x=X,y=total]  {benchmarks/cuda_magma_numerical_2D.csv};
    % \addplot[set15,mark=*,mark options={fill=white}, very thick] table[x=X,y=TOTAL] {benchmarks/openmp_direct_numerical.csv};
    % \addplot[set16,mark=*,mark options={fill=white}, very thick] table[x=X,y=TOTAL] {benchmarks/openmp_direct_analytical.csv};

    \legend{Fortran (Original\, Linear Scaling), CUDA (GMRES\, Numerical\, 2D), CUDA (BiCGStab\, Numerical\, 2D), CUDA (MAGMA\, Numerical\, 2D), OpenMP (Direct\, Numerical), OpenMP (Direct\, Analytical)}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Total time per timestep using the average over 10 timesteps. First timestep is excluded as warmup. Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/cuda_magma_numerical_2D.csv}\loadedtable
    \begin{axis}[
      stack plots=y,
      area style,
      title=Steps (CUDA Magma),
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=3,
      ]
    \addplot[color=set11, fill=set11_light, very thick] table[x=X,y=assemble_system] {\loadedtable} \closedcycle;
    \addplot[color=set12, fill=set12_light, very thick] table[x=X,y=solve_system] {\loadedtable} \closedcycle;
    % update_fibers is so small it just causes ugly undefined jagginess of the lines
    % so we just add it to update velocities and rename both to update system
    \addplot[color=set13, fill=set13_light, very thick] table[x=X,y expr=\thisrow{update_velocities} + \thisrow{update_fibers}] {\loadedtable} \closedcycle;
    % \addplot[color=set14, fill=set14_light, very thick] table[x=X,y=update_fibers] {\loadedtable} \closedcycle;

    \legend{Assemble System, Solve System (MAGMA), Update System}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for each simulation step over 10 timesteps. First timestep is excluded as warmup.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/katarina_gmres_analytical.csv}\loadedtable
    \begin{axis}[
      stack plots=y,
      area style,
      title=Steps (Fortran Original),
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=110,
      ]
    \addplot[color=set11, fill=set11_light, very thick] table[x=X,y=ASSEMBLE_MATRIX] {\loadedtable} \closedcycle;
    \addplot[color=set12, fill=set12_light, very thick] table[x=X,y=SOLVE_SYSTEM] {\loadedtable} \closedcycle;
    % update_fibers is so small it just causes ugly undefined jagginess of the lines
    % so we just add it to update velocities and rename both to update system
    \addplot[color=set13, fill=set13_light, very thick] table[x=X,y expr=\thisrow{UPDATE_VELOCITIES} + \thisrow{UPDATE_FIBERS}] {\loadedtable} \closedcycle;
    % \addplot[color=set14, fill=set14_light, very thick] table[x=X,y=update_fibers] {\loadedtable} \closedcycle;

    \legend{Assemble System, Solve System, Update System}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for each simulation step over 10 timesteps. First timestep is excluded as warmup. Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/openmp_direct_analytical.csv}\loadedtable
    \begin{axis}[
      stack plots=y,
      area style,
      title=Steps (OpenMP analytical),
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=9,
      ]
    \addplot[color=set11, fill=set11_light, very thick] table[x=X,y=ASSEMBLE_SYSTEM] {\loadedtable} \closedcycle;
    \addplot[color=set12, fill=set12_light, very thick] table[x=X,y=SOLVE_SYSTEM] {\loadedtable} \closedcycle;
    % update_fibers is so small it just causes ugly undefined jagginess of the lines
    % so we just add it to update velocities and rename both to update system
    \addplot[color=set13, fill=set13_light, very thick] table[x=X,y expr=\thisrow{UPDATE_VELOCITIES} + \thisrow{UPDATE_FIBERS}] {\loadedtable} \closedcycle;
    % \addplot[color=set14, fill=set14_light, very thick] table[x=X,y=update_fibers] {\loadedtable} \closedcycle;

    \legend{Assemble System, Solve System, Update System}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for each simulation step over 10 timesteps. First timestep is excluded as warmup. Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \begin{axis}[
      title=Solve System Comparison,
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=6,
      ]
    \addplot[color=set11,mark=*,mark options={fill=white}, very thick] table[x=X,y expr=\thisrow{SOLVE_SYSTEM} * 0.125] {benchmarks/katarina_gmres_analytical.csv};
    \addplot[color=set12,mark=*,mark options={fill=white}, very thick] table[x=X,y=solve_system]  {benchmarks/cuda_gmres_numerical_2D.csv};
    \addplot[color=set13,mark=*,mark options={fill=white}, very thick] table[x=X,y=solve_system]  {benchmarks/cuda_bicgstab_numerical_2D.csv};
    \addplot[color=set14,mark=*,mark options={fill=white}, very thick] table[x=X,y=solve_system]  {benchmarks/cuda_magma_numerical_2D.csv};
    \addplot[color=set15,mark=*,mark options={fill=white}, very thick] table[x=X,y=SOLVE_SYSTEM] {benchmarks/openmp_direct_numerical.csv};

    \legend{Solve System (Fortran\, Original\, GMRES), Solve System (CUDA\, GMRES), Solve System (CUDA\, BiCGStab), Solve System (CUDA\, MAGMA), Solve System (OpenMP\, OpenBLAS)}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for solve system step. Averaged over 10 timesteps (1st excluded). Assuming linear scaling for Fortran.}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \begin{axis}[
      title=Assemble System Comparison,
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      xmin=0,xmax=700,
      ymin=0,ymax=8
      ]
    \addplot[color=set11,mark=*,mark options={fill=white}, very thick] table[x=X,y expr=(\thisrow{ASSEMBLE_MATRIX} + \thisrow{ASSEMBLE_RHS}) * 0.125] {benchmarks/katarina_gmres_analytical.csv};
    \addplot[color=set12,mark=*,mark options={fill=white}, very thick] table[x=X,y=assemble_system] {benchmarks/cuda_magma_numerical_2D.csv};
    \addplot[color=set13,mark=*,mark options={fill=white}, very thick] table[x=X,y=assemble_system] {benchmarks/cuda_bicgstab_analytical_2D.csv};
    \addplot[color=set14,mark=*,mark options={fill=white}, very thick] table[x=X,y=ASSEMBLE_SYSTEM] {benchmarks/openmp_direct_numerical.csv};
    \addplot[color=set15,mark=*,mark options={fill=white}, very thick] table[x=X,y=ASSEMBLE_SYSTEM] {benchmarks/openmp_direct_analytical.csv};

    \legend{Assemble System (Fortran\, Analytical), Assemble System (CUDA\, Numerical), Assemble System (CUDA\, Analytical), Assemble System (OpenMP\, Numerical), Assemble System (OpenMP\, Analytical)}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Average time for assemble system step. Fortran and CUDA are averaged over 10 timesteps (1st excluded). Fortran New is only 1st timestep. Assuming linear scaling for Fortran.}
\end{figure}


\begin{figure}
  \centering
  \begin{tikzpicture}
    \setmathfont{FiraSans-Book.otf}
    \pgfplotstableread{benchmarks/assemble_system_grid.csv}\loadedtable
    \begin{axis}[
      title=CUDA Grid Dimension,
      xlabel={number of fibers},
      ylabel={simulation time (sec)},
      ymin=0,ymax=0.8,
      xmin=0,xmax=700,
      unbounded coords=discard,
      ]
    \addplot[set11,mark=*,mark options={fill=white}, very thick] table[x=X,y=1D] {\loadedtable};
    \addplot[set12,mark=*,mark options={fill=white}, very thick] table[x=X,y=2D] {\loadedtable};
    \addplot[set13,mark=*,mark options={fill=white}, very thick] table[x=X,y=3D] {\loadedtable};
    \addplot[set14,mark=*,mark options={fill=white}, very thick] table[x=X,y=3D2] {\loadedtable};

    \legend{1D, 2D, 3D, 3D2}
    \end{axis}
    \setmathfont{XITS Math}
  \end{tikzpicture}
  \caption{Total time per timestep using the average over 10 timesteps. First timestep is excluded as warmup.}
\end{figure}

\chapter{Theoretical Foundation}

\chapter{CPU Implementation}
\section{Discretization}
\section{Timestepping}

\chapter{GPU Implementation}
\section{CUDA}
\section{Kernels}
\section{Optimizations}
\subsection{Numerically vs. Analytically}
\subsection{Grid Dimension}
\subsection{Shared Memory}

\chapter{Results}
\section{Fair comparison}
\section{Fortran vs. CUDA}
\section{Grid Dimension}
\section{Scaling}

\chapter{Conclusion}

\appendix
\addappheadtotoc

\end{document}
